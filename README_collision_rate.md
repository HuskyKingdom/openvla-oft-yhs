# 负样本冲突率统计脚本使用说明

## 概述

`compute_negative_collision_rate.py` 用于计算随机采样负样本中的冲突比例，证明数据的稀疏性。

## 实验目的

统计满足以下两个条件的负样本对的比例：
1. **相同的任务（Identity）**：两条数据都是相同的任务描述（如 "Pick up the red cup"）
2. **相似的状态（State）**：机器人的视觉输入或状态非常相似（余弦相似度 > 0.95）

最终计算出冲突率 X%，证明"随机采样的负样本几乎总是安全的"。

## 使用方法

### 基本用法

```bash
python compute_negative_collision_rate.py \
    --data_root_dir datasets/rlds \
    --dataset_name aloha_scoop_x_into_bowl \
    --vla_path openvla/openvla-7b \
    --batch_size 8 \
    --num_batches 100 \
    --similarity_threshold 0.95
```

### 参数说明

- `--data_root_dir`: 数据根目录（默认: `datasets/rlds`）
- `--dataset_name`: 数据集名称（默认: `aloha_scoop_x_into_bowl`）
- `--vla_path`: VLA模型路径，可以是HuggingFace Hub上的模型ID或本地路径（默认: `openvla/openvla-7b`）
- `--batch_size`: 批次大小（默认: 8）
- `--num_batches`: 统计的批次数量（默认: 100）
- `--similarity_threshold`: 状态相似度阈值（默认: 0.95）
- `--device`: 设备，cuda 或 cpu（默认: cuda）

### 输出结果

脚本会输出以下统计信息：

```
统计结果
================================================================================
总冲突对数: X
总负样本对数: Y
冲突率: Z.XXXX%
平均批次冲突率: A.AAAA%
批次冲突率标准差: B.BBBB%
最小批次冲突率: C.CCCC%
最大批次冲突率: D.DDDD%
================================================================================

结论: 随机采样的负样本中，只有 Z.XXXX% 是冲突的（False Negative）
这证明了数据的稀疏性：随机采样的负样本几乎总是安全的。
```

## 技术细节

### 1. 任务描述提取

脚本通过扩展 `RLDSBatchTransform` 来保存原始任务描述（`language_instruction`），确保能够正确识别相同任务。

### 2. 图像特征提取

使用预训练的 CLIP 模型（ViT-B/32）提取图像特征，确保客观性（不使用正在训练的头）。

### 3. 相似度计算

- 使用余弦相似度计算状态相似度
- 相似度阈值默认为 0.95（可调整）

### 4. 冲突判断

对于每一对负样本 (i, j)，同时满足以下条件才认为是冲突：
- 条件A: `task_descriptions[i] == task_descriptions[j]`
- 条件B: `similarity_matrix[i, j] > similarity_threshold`

### 5. 统计计算

```
冲突率 = (冲突对数 / 总负样本对数) × 100%
总负样本对数 = N × (N - 1) / 2  （N为批次大小）
```

## 注意事项

1. **CLIP模型下载**：首次运行时会自动下载CLIP模型（ViT-B/32），需要网络连接。

2. **内存使用**：如果遇到内存不足，可以：
   - 减小 `batch_size`
   - 减小 `num_batches`
   - 使用 `--device cpu`（速度较慢）

3. **数据增强**：脚本默认关闭数据增强（`image_aug=False`），以保证统计的客观性。

4. **相似度阈值**：可以根据实际需求调整 `similarity_threshold`，但通常 0.95 是一个合理的阈值。

## 预期结果

根据理论预期，冲突率 X% 应该非常小（通常 < 0.5% 或 < 0.1%），这证明了：
- 随机采样的负样本几乎总是安全的
- 数据的稀疏性使得负样本对很少同时满足"相同任务"和"相似状态"两个条件

## 故障排除

### 问题1: 找不到 language_instruction 字段

**原因**：batch transform 可能没有正确保存任务描述。

**解决**：检查 `TaskAwareRLDSBatchTransform` 是否正确继承并保存了 `language_instruction` 字段。

### 问题2: CLIP模型加载失败

**原因**：网络问题或缺少依赖。

**解决**：
- 检查网络连接
- 确保已安装 `clip` 库：`pip install git+https://github.com/openai/CLIP.git`
- 尝试使用CPU：`--device cpu`

### 问题3: 内存不足

**原因**：批次太大或模型太大。

**解决**：
- 减小 `batch_size`
- 使用更小的CLIP模型（需要修改代码）
- 使用CPU（虽然慢但内存占用更小）

## 示例输出

```
================================================================================
负样本冲突率统计实验
================================================================================
数据集: aloha_scoop_x_into_bowl
批次大小: 8
统计批次数: 100
相似度阈值: 0.95
================================================================================
正在加载CLIP模型...
正在加载VLA处理器...
正在加载数据集: aloha_scoop_x_into_bowl
开始统计，将处理 100 个批次...
100%|████████████████████████████████| 100/100 [05:23<00:00,  3.23s/it]
已处理 100 个批次，当前冲突率: 0.0234%

================================================================================
统计结果
================================================================================
总冲突对数: 7
总负样本对数: 2800
冲突率: 0.0250%
平均批次冲突率: 0.0250%
批次冲突率标准差: 0.0123%
最小批次冲突率: 0.0000%
最大批次冲突率: 0.0714%
================================================================================

结论: 随机采样的负样本中，只有 0.0250% 是冲突的（False Negative）
这证明了数据的稀疏性：随机采样的负样本几乎总是安全的。
================================================================================
```

